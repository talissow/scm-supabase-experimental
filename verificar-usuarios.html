<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Usu√°rios - SCM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .user-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .user-email {
            font-weight: bold;
            color: #007bff;
        }
        .user-role {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .role-admin {
            background: #fff3cd;
            color: #856404;
        }
        .role-user {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verifica√ß√£o de Usu√°rios - SCM</h1>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button class="btn" onclick="checkAllUsers()">üìã Ver Todos os Usu√°rios</button>
            <button class="btn btn-success" onclick="checkCurrentUser()">üë§ Ver Usu√°rio Atual</button>
            <button class="btn btn-warning" onclick="fixCurrentUser()">üîß Corrigir Usu√°rio Atual</button>
        </div>
        
        <div id="results"></div>
    </div>

    <!-- Scripts do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <script>
        let supabaseClient;
        
        // Inicializar Supabase
        async function initSupabase() {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase inicializado');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                showResult('‚ùå Erro ao inicializar Supabase: ' + error.message, 'error');
                return false;
            }
        }
        
        // Mostrar resultado na tela
        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'results';
            resultsDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        // Verificar todos os usu√°rios
        async function checkAllUsers() {
            showResult('<div class="loading">üîç Buscando usu√°rios...</div>');
            
            try {
                if (!supabaseClient) {
                    await initSupabase();
                }
                
                // Buscar usu√°rios da tabela users
                const { data: users, error: usersError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (usersError) {
                    throw new Error('Erro ao buscar usu√°rios: ' + usersError.message);
                }
                
                if (!users || users.length === 0) {
                    showResult('‚ùå Nenhum usu√°rio encontrado na tabela users', 'error');
                    return;
                }
                
                // Estat√≠sticas
                const adminCount = users.filter(u => u.role === 'admin').length;
                const userCount = users.filter(u => u.role === 'user').length;
                const activeCount = users.filter(u => u.is_active).length;
                const inactiveCount = users.filter(u => !u.is_active).length;
                
                let html = `
                    <h3>üìä Estat√≠sticas dos Usu√°rios</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${users.length}</div>
                            <div class="stat-label">Total de Usu√°rios</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${adminCount}</div>
                            <div class="stat-label">Administradores</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${userCount}</div>
                            <div class="stat-label">Usu√°rios Comuns</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${activeCount}</div>
                            <div class="stat-label">Usu√°rios Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${inactiveCount}</div>
                            <div class="stat-label">Usu√°rios Inativos</div>
                        </div>
                    </div>
                    
                    <h3>üë• Lista de Usu√°rios</h3>
                `;
                
                users.forEach((user, index) => {
                    const roleClass = user.role === 'admin' ? 'role-admin' : 'role-user';
                    const statusClass = user.is_active ? 'status-active' : 'status-inactive';
                    const statusText = user.is_active ? 'Ativo' : 'Inativo';
                    
                    html += `
                        <div class="user-card">
                            <div class="user-email">${user.email}</div>
                            <div><strong>Nome:</strong> ${user.full_name || 'N/A'}</div>
                            <div><strong>ID:</strong> ${user.id}</div>
                            <div><strong>Role:</strong> <span class="user-role ${roleClass}">${user.role}</span></div>
                            <div><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
                            <div><strong>Criado em:</strong> ${new Date(user.created_at).toLocaleString('pt-BR')}</div>
                            <div><strong>Atualizado em:</strong> ${new Date(user.updated_at).toLocaleString('pt-BR')}</div>
                        </div>
                    `;
                });
                
                showResult(html);
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showResult('‚ùå Erro ao buscar usu√°rios: ' + error.message, 'error');
            }
        }
        
        // Verificar usu√°rio atual
        async function checkCurrentUser() {
            showResult('<div class="loading">üîç Verificando usu√°rio atual...</div>');
            
            try {
                if (!supabaseClient) {
                    await initSupabase();
                }
                
                // Verificar sess√£o
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    throw new Error('Erro ao verificar sess√£o: ' + sessionError.message);
                }
                
                if (!session) {
                    showResult('‚ùå Nenhuma sess√£o ativa. Fa√ßa login primeiro.', 'error');
                    return;
                }
                
                let html = `
                    <h3>üë§ Usu√°rio Atual (Supabase Auth)</h3>
                    <div class="user-card">
                        <div class="user-email">${session.user.email}</div>
                        <div><strong>ID:</strong> ${session.user.id}</div>
                        <div><strong>Nome:</strong> ${session.user.user_metadata?.full_name || 'N/A'}</div>
                        <div><strong>Email verificado:</strong> ${session.user.email_confirmed_at ? 'Sim' : 'N√£o'}</div>
                        <div><strong>Criado em:</strong> ${new Date(session.user.created_at).toLocaleString('pt-BR')}</div>
                        <div><strong>√öltimo acesso:</strong> ${new Date(session.user.last_sign_in_at).toLocaleString('pt-BR')}</div>
                    </div>
                `;
                
                // Verificar se existe na tabela users
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (userError) {
                    html += `
                        <div class="error">
                            ‚ùå Usu√°rio n√£o encontrado na tabela users<br>
                            <strong>Erro:</strong> ${userError.message}<br>
                            <strong>Solu√ß√£o:</strong> Execute "Corrigir Usu√°rio Atual" para criar o registro
                        </div>
                    `;
                } else {
                    const roleClass = userData.role === 'admin' ? 'role-admin' : 'role-user';
                    const statusClass = userData.is_active ? 'status-active' : 'status-inactive';
                    const statusText = userData.is_active ? 'Ativo' : 'Inativo';
                    
                    html += `
                        <h3>üë§ Perfil na Tabela Users</h3>
                        <div class="user-card">
                            <div class="user-email">${userData.email}</div>
                            <div><strong>Nome:</strong> ${userData.full_name || 'N/A'}</div>
                            <div><strong>ID:</strong> ${userData.id}</div>
                            <div><strong>Role:</strong> <span class="user-role ${roleClass}">${userData.role}</span></div>
                            <div><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
                            <div><strong>Criado em:</strong> ${new Date(userData.created_at).toLocaleString('pt-BR')}</div>
                            <div><strong>Atualizado em:</strong> ${new Date(userData.updated_at).toLocaleString('pt-BR')}</div>
                        </div>
                    `;
                    
                    if (userData.role !== 'admin') {
                        html += `
                            <div class="error">
                                ‚ö†Ô∏è Usu√°rio n√£o √© administrador<br>
                                <strong>Role atual:</strong> ${userData.role}<br>
                                <strong>Solu√ß√£o:</strong> Execute "Corrigir Usu√°rio Atual" para definir como admin
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="success">
                                ‚úÖ Usu√°rio √© administrador e tem acesso completo ao sistema!
                            </div>
                        `;
                    }
                }
                
                showResult(html);
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showResult('‚ùå Erro ao verificar usu√°rio atual: ' + error.message, 'error');
            }
        }
        
        // Corrigir usu√°rio atual
        async function fixCurrentUser() {
            showResult('<div class="loading">üîß Corrigindo usu√°rio atual...</div>');
            
            try {
                if (!supabaseClient) {
                    await initSupabase();
                }
                
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    showResult('‚ùå Nenhuma sess√£o ativa. Fa√ßa login primeiro.', 'error');
                    return;
                }
                
                // Verificar se j√° existe na tabela users
                const { data: existingUser } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', session.user.email)
                    .single();
                
                let result;
                
                if (existingUser) {
                    // Atualizar usu√°rio existente
                    const { error: updateError } = await supabaseClient
                        .from('users')
                        .update({
                            id: session.user.id,
                            full_name: session.user.user_metadata?.full_name || 'Talisson Sousa de Santana',
                            role: 'admin',
                            is_active: true
                        })
                        .eq('email', session.user.email);
                    
                    if (updateError) {
                        throw new Error('Erro ao atualizar usu√°rio: ' + updateError.message);
                    }
                    
                    result = '‚úÖ Usu√°rio atualizado com sucesso! Role definido como admin.';
                } else {
                    // Criar novo usu√°rio
                    const { error: insertError } = await supabaseClient
                        .from('users')
                        .insert({
                            id: session.user.id,
                            email: session.user.email,
                            full_name: session.user.user_metadata?.full_name || 'Talisson Sousa de Santana',
                            role: 'admin',
                            is_active: true
                        });
                    
                    if (insertError) {
                        throw new Error('Erro ao criar usu√°rio: ' + insertError.message);
                    }
                    
                    result = '‚úÖ Usu√°rio criado com sucesso! Role definido como admin.';
                }
                
                showResult(`
                    <div class="success">
                        ${result}<br><br>
                        <strong>Dados atualizados:</strong><br>
                        ‚Ä¢ Email: ${session.user.email}<br>
                        ‚Ä¢ Nome: ${session.user.user_metadata?.full_name || 'Talisson Sousa de Santana'}<br>
                        ‚Ä¢ Role: admin<br>
                        ‚Ä¢ Status: ativo<br><br>
                        <strong>Pr√≥ximos passos:</strong><br>
                        1. Recarregue a p√°gina principal do sistema<br>
                        2. O bot√£o "‚öôÔ∏è Admin" deve aparecer no header<br>
                        3. A aba "üë• Usu√°rios" ficar√° vis√≠vel
                    </div>
                `, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showResult('‚ùå Erro ao corrigir usu√°rio: ' + error.message, 'error');
            }
        }
        
        // Inicializar quando carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            initSupabase();
        });
    </script>
</body>
</html>
