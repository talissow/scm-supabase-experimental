// ===== PAINEL DE ADMINISTRA√á√ÉO SIMPLIFICADO =====
// Apenas admin@scm.local tem acesso de administrador

// Verificar se usu√°rio √© admin e mostrar elementos
async function checkAdminAccess() {
    try {
        console.log('üîç Verificando acesso de admin...');
        
        if (typeof auth !== 'undefined' && typeof auth.getUserProfile === 'function') {
            const userProfile = await auth.getUserProfile();
            // Apenas admin@scm.local √© admin
            const isAdmin = userProfile && userProfile.email === 'admin@scm.local' && userProfile.role === 'admin';
            console.log('üß™ Verificando admin:', userProfile?.email, '√© admin:', isAdmin);
            
            if (isAdmin) {
                // Mostrar bot√£o admin no header
                const adminButton = document.getElementById('adminButton');
                if (adminButton) {
                    adminButton.style.display = 'block';
                    console.log('‚úÖ Bot√£o admin exibido');
                }
                
                // Mostrar bot√£o gerenciar usu√°rios
                const manageUsersButton = document.getElementById('manageUsersButton');
                if (manageUsersButton) {
                    manageUsersButton.style.display = 'inline-block';
                    console.log('‚úÖ Bot√£o gerenciar usu√°rios exibido');
                }
                
                // Mostrar aba admin
                const adminTab = document.querySelector('[data-tab="admin"]');
                if (adminTab) {
                    adminTab.style.display = 'block';
                    console.log('‚úÖ Aba admin exibida');
                }
                
                // Definir perfil do usu√°rio globalmente
                window.currentUserProfile = userProfile;
                
                console.log('‚úÖ Acesso de administrador concedido para admin@scm.local');
            } else {
                console.log('‚ùå Acesso negado - apenas admin@scm.local tem acesso de administrador');
                console.log('üë§ Email atual:', userProfile?.email);
                console.log('üí° Use a conta admin padr√£o: admin@scm.local / admin123456');
            }
        } else {
            console.error('‚ùå M√≥dulo de autentica√ß√£o n√£o dispon√≠vel');
        }
    } catch (error) {
        console.error('‚ùå Erro ao verificar acesso admin:', error);
    }
}

// Carregar lista de usu√°rios
async function loadUsers() {
    try {
        const { data: users, error } = await supabaseClient
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('‚ùå Erro ao carregar usu√°rios:', error);
            return;
        }

        renderUsersTable(users);
        updateAdminStats(users);
    } catch (error) {
        console.error('‚ùå Erro inesperado ao carregar usu√°rios:', error);
    }
}

// Renderizar tabela de usu√°rios
function renderUsersTable(users) {
    const tbody = document.querySelector('#usersTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.email}</td>
            <td>${user.full_name || 'N/A'}</td>
            <td><span class="role-badge ${user.role}">${user.role}</span></td>
            <td><span class="status-badge ${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Ativo' : 'Inativo'}</span></td>
            <td>${new Date(user.created_at).toLocaleDateString('pt-BR')}</td>
            <td>
                <div class="user-actions-btns">
                    <button onclick="editUser('${user.id}')" class="btn btn-sm btn-primary">‚úèÔ∏è Editar</button>
                    <button onclick="deleteUser('${user.id}')" class="btn btn-sm btn-danger">üóëÔ∏è Excluir</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Atualizar estat√≠sticas do admin
function updateAdminStats(users) {
    const totalUsers = users.length;
    const activeUsers = users.filter(u => u.is_active).length;
    const adminUsers = users.filter(u => u.role === 'admin').length;

    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('activeUsers').textContent = activeUsers;
    document.getElementById('adminUsers').textContent = adminUsers;
}

// Mostrar modal de criar/editar usu√°rio
async function showCreateUserModal(userId = null) {
    const modal = document.getElementById('userModal');
    const modalTitle = document.getElementById('userModalTitle');
    const form = document.getElementById('userForm');

    if (userId) {
        modalTitle.textContent = '‚úèÔ∏è Editar Usu√°rio';
        
        try {
            // Buscar dados do usu√°rio
            const { data: user, error } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();

            if (error) throw error;

            // Preencher formul√°rio
            document.getElementById('userId').value = user.id;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userFullName').value = user.full_name || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userIsActive').checked = user.is_active;
            
            // Ocultar campo de senha para edi√ß√£o
            const passwordField = document.getElementById('userPassword').parentElement;
            passwordField.style.display = 'none';
        } catch (error) {
            console.error('Erro ao carregar usu√°rio:', error);
            alert('‚ùå Erro ao carregar dados do usu√°rio');
            return;
        }
    } else {
        modalTitle.textContent = '‚ûï Novo Usu√°rio';
        form.reset();
        document.getElementById('userId').value = '';
        
        // Mostrar campo de senha para cria√ß√£o
        const passwordField = document.getElementById('userPassword').parentElement;
        passwordField.style.display = 'block';
    }

    modal.style.display = 'block';
}

// Lidar com envio do formul√°rio de usu√°rio
async function handleUserSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const userId = document.getElementById('userId').value;
    const userData = {
        email: formData.get('email'),
        full_name: formData.get('full_name'),
        role: formData.get('role'),
        is_active: formData.get('is_active') === 'on'
    };

    try {
        if (userId) {
            // Atualizar usu√°rio existente
            const { error } = await supabaseClient
                .from('users')
                .update(userData)
                .eq('id', userId);

            if (error) throw error;
            
            alert('‚úÖ Usu√°rio atualizado com sucesso!');
        } else {
            // Criar novo usu√°rio
            const { data: authData, error: authError } = await supabaseClient.auth.admin.createUser({
                email: userData.email,
                password: formData.get('password'),
                email_confirm: true,
                user_metadata: {
                    full_name: userData.full_name
                }
            });

            if (authError) throw authError;

            const { error: userError } = await supabaseClient
                .from('users')
                .insert({
                    id: authData.user.id,
                    email: userData.email,
                    full_name: userData.full_name,
                    role: userData.role,
                    is_active: userData.is_active
                });

            if (userError) throw userError;
            
            alert('‚úÖ Usu√°rio criado com sucesso!');
        }
        
        // Fechar modal
        closeUserModal();
        
        // Recarregar lista
        loadUsers();
    } catch (error) {
        console.error('Erro ao salvar usu√°rio:', error);
        alert('‚ùå Erro ao salvar usu√°rio: ' + error.message);
    }
}

// Editar usu√°rio
function editUser(userId) {
    showCreateUserModal(userId);
}

// Excluir usu√°rio
async function deleteUser(userId) {
    try {
        // Buscar dados do usu√°rio
        const { data: user, error } = await supabaseClient
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();

        if (error) throw error;

        // N√£o permitir exclus√£o do admin padr√£o
        if (user.email === 'admin@scm.local') {
            alert('‚ùå N√£o √© poss√≠vel excluir o administrador padr√£o do sistema!');
            return;
        }

        const modal = document.getElementById('deleteUserModal');
        const userNameElement = document.getElementById('deleteUserName');
        
        if (userNameElement) {
            userNameElement.textContent = user.full_name || user.email;
        }
        
        modal.style.display = 'block';
        
        // Armazenar ID para exclus√£o
        modal.dataset.userId = userId;
    } catch (error) {
        console.error('Erro ao carregar usu√°rio:', error);
        alert('‚ùå Erro ao carregar dados do usu√°rio');
    }
}

// Fechar modal de usu√°rio
function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

// Confirmar exclus√£o de usu√°rio
async function confirmDeleteUser() {
    const modal = document.getElementById('deleteUserModal');
    const userId = modal.dataset.userId;
    
    if (!userId) {
        alert('‚ùå ID do usu√°rio n√£o encontrado');
        return;
    }

    try {
        // Excluir usu√°rio da tabela users
        const { error: userError } = await supabaseClient
            .from('users')
            .delete()
            .eq('id', userId);

        if (userError) throw userError;

        // Excluir usu√°rio do Auth (opcional - pode manter para hist√≥rico)
        // const { error: authError } = await supabaseClient.auth.admin.deleteUser(userId);
        // if (authError) console.warn('Aviso: Erro ao excluir do Auth:', authError);
        
        alert('‚úÖ Usu√°rio exclu√≠do com sucesso!');
        
        // Fechar modal
        closeDeleteUserModal();
        
        // Recarregar lista
        loadUsers();
    } catch (error) {
        console.error('Erro ao excluir usu√°rio:', error);
        alert('‚ùå Erro ao excluir usu√°rio: ' + error.message);
    }
}

// Fechar modal de confirma√ß√£o de exclus√£o
function closeDeleteUserModal() {
    document.getElementById('deleteUserModal').style.display = 'none';
}

// Sistema simplificado - apenas admin@scm.local √© admin
console.log('‚ÑπÔ∏è Sistema simplificado: apenas admin@scm.local tem acesso de administrador');

// Inicializar quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
    // Aguardar um pouco para garantir que auth esteja inicializado
    setTimeout(() => {
        checkAdminAccess();
    }, 1500);
});