<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema de Autentica√ß√£o - SCM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 5px;
            transition: transform 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
        }

        .test-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin: 10px 0;
        }

        .user-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .user-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .user-info p {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Teste do Sistema de Autentica√ß√£o</h1>

        <!-- Status da Conex√£o -->
        <div class="test-section">
            <h2>üì° Status da Conex√£o</h2>
            <div id="connectionStatus" class="status info">Verificando conex√£o...</div>
            <button class="test-button" onclick="checkConnection()">Verificar Conex√£o</button>
        </div>

        <!-- Teste de Login -->
        <div class="test-section">
            <h2>üîë Teste de Login</h2>
            <div class="form-group">
                <label for="testEmail">Email:</label>
                <input type="email" id="testEmail" placeholder="seu-email@exemplo.com">
            </div>
            <div class="form-group">
                <label for="testPassword">Senha:</label>
                <input type="password" id="testPassword" placeholder="Sua senha">
            </div>
            <button class="test-button" onclick="testLogin()">Testar Login</button>
            <div class="loading" id="loginLoading">üîÑ Testando login...</div>
            <div id="loginResults" class="test-results" style="display: none;"></div>
        </div>

        <!-- Informa√ß√µes do Usu√°rio -->
        <div class="test-section">
            <h2>üë§ Informa√ß√µes do Usu√°rio</h2>
            <div id="userInfo" class="user-info" style="display: none;">
                <h3>Usu√°rio Logado</h3>
                <p id="userDetails"></p>
            </div>
            <button class="test-button" onclick="getUserInfo()">Obter Informa√ß√µes do Usu√°rio</button>
            <button class="test-button" onclick="testLogout()">Testar Logout</button>
        </div>

        <!-- Teste de Permiss√µes -->
        <div class="test-section">
            <h2>üõ°Ô∏è Teste de Permiss√µes</h2>
            <button class="test-button" onclick="testAdminCheck()">Verificar se √© Admin</button>
            <button class="test-button" onclick="testAuthRequired()">Testar Requisi√ß√£o de Auth</button>
            <div id="permissionsResults" class="test-results" style="display: none;"></div>
        </div>

        <!-- Teste de Opera√ß√µes CRUD -->
        <div class="test-section">
            <h2>üìù Teste de Opera√ß√µes CRUD</h2>
            <button class="test-button" onclick="testProductCRUD()">Testar CRUD de Produtos</button>
            <button class="test-button" onclick="testMovementCRUD()">Testar CRUD de Movimenta√ß√µes</button>
            <div class="loading" id="crudLoading">üîÑ Testando opera√ß√µes...</div>
            <div id="crudResults" class="test-results" style="display: none;"></div>
        </div>

        <!-- Teste de Auditoria -->
        <div class="test-section">
            <h2>üìã Teste de Auditoria</h2>
            <button class="test-button" onclick="testAuditLog()">Verificar Log de Auditoria</button>
            <div class="loading" id="auditLoading">üîÑ Verificando auditoria...</div>
            <div id="auditResults" class="test-results" style="display: none;"></div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="test-section">
            <h2>üîó Navega√ß√£o</h2>
            <button class="test-button" onclick="window.open('login.html', '_blank')">Abrir Tela de Login</button>
            <button class="test-button" onclick="window.open('SCM_Supabase.html', '_blank')">Abrir Sistema Principal</button>
            <button class="test-button" onclick="window.open('usuarios.html', '_blank')">Abrir Gerenciamento de Usu√°rios</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth.js"></script>
    
    <script>
        let isAuthenticated = false;

        // Verificar status inicial
        document.addEventListener('DOMContentLoaded', async () => {
            await checkConnection();
            await getUserInfo();
        });

        // Verificar conex√£o
        async function checkConnection() {
            try {
                const statusDiv = document.getElementById('connectionStatus');
                
                if (typeof supabaseClient === 'undefined') {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Supabase n√£o configurado';
                    return;
                }

                // Testar conex√£o b√°sica
                const { data, error } = await supabaseClient.from('products').select('count').limit(1);
                
                if (error) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Erro de conex√£o: ' + error.message;
                } else {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Conex√£o com Supabase OK';
                }
            } catch (error) {
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectionStatus').textContent = '‚ùå Erro: ' + error.message;
            }
        }

        // Testar login
        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const resultsDiv = document.getElementById('loginResults');
            const loadingDiv = document.getElementById('loginLoading');

            if (!email || !password) {
                showResults('loginResults', '‚ùå Email e senha s√£o obrigat√≥rios', 'error');
                return;
            }

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            try {
                const result = await auth.login(email, password);
                
                if (result.success) {
                    isAuthenticated = true;
                    showResults('loginResults', '‚úÖ Login realizado com sucesso!', 'success');
                    await getUserInfo();
                } else {
                    showResults('loginResults', '‚ùå Erro no login: ' + result.error, 'error');
                }
            } catch (error) {
                showResults('loginResults', '‚ùå Erro inesperado: ' + error.message, 'error');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Obter informa√ß√µes do usu√°rio
        async function getUserInfo() {
            try {
                const userInfoDiv = document.getElementById('userInfo');
                const userDetailsDiv = document.getElementById('userDetails');

                if (await auth.init()) {
                    const currentUser = auth.getCurrentUser();
                    const userProfile = await auth.getUserProfile();
                    
                    if (currentUser && userProfile) {
                        userInfoDiv.style.display = 'block';
                        userDetailsDiv.innerHTML = `
                            <strong>Email:</strong> ${currentUser.email}<br>
                            <strong>Nome:</strong> ${userProfile.full_name || 'N√£o informado'}<br>
                            <strong>Fun√ß√£o:</strong> ${userProfile.role}<br>
                            <strong>Ativo:</strong> ${userProfile.is_active ? 'Sim' : 'N√£o'}<br>
                            <strong>ID:</strong> ${currentUser.id}
                        `;
                        isAuthenticated = true;
                    } else {
                        userInfoDiv.style.display = 'none';
                        isAuthenticated = false;
                    }
                } else {
                    userInfoDiv.style.display = 'none';
                    isAuthenticated = false;
                }
            } catch (error) {
                console.error('Erro ao obter informa√ß√µes do usu√°rio:', error);
            }
        }

        // Testar logout
        async function testLogout() {
            try {
                const success = await auth.logout();
                if (success) {
                    showResults('loginResults', '‚úÖ Logout realizado com sucesso!', 'success');
                    document.getElementById('userInfo').style.display = 'none';
                    isAuthenticated = false;
                } else {
                    showResults('loginResults', '‚ùå Erro no logout', 'error');
                }
            } catch (error) {
                showResults('loginResults', '‚ùå Erro inesperado no logout: ' + error.message, 'error');
            }
        }

        // Testar verifica√ß√£o de admin
        async function testAdminCheck() {
            try {
                const isAdmin = await auth.isAdmin();
                const message = isAdmin ? '‚úÖ Usu√°rio √© administrador' : '‚ÑπÔ∏è Usu√°rio n√£o √© administrador';
                showResults('permissionsResults', message, isAdmin ? 'success' : 'info');
            } catch (error) {
                showResults('permissionsResults', '‚ùå Erro ao verificar admin: ' + error.message, 'error');
            }
        }

        // Testar requisi√ß√£o de auth
        function testAuthRequired() {
            const required = auth.requireAuth();
            const message = required ? '‚úÖ Autentica√ß√£o OK' : '‚ùå Autentica√ß√£o necess√°ria';
            showResults('permissionsResults', message, required ? 'success' : 'warning');
        }

        // Testar CRUD de produtos
        async function testProductCRUD() {
            const resultsDiv = document.getElementById('crudResults');
            const loadingDiv = document.getElementById('crudLoading');

            if (!isAuthenticated) {
                showResults('crudResults', '‚ùå Fa√ßa login primeiro', 'error');
                return;
            }

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            try {
                const testProduct = {
                    id: 'test-product-' + Date.now(),
                    name: 'Produto Teste',
                    description: 'Produto criado pelo teste',
                    type: 'teste',
                    quantity: 10,
                    minQuantity: 5,
                    unit: 'unid'
                };

                // Criar produto
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('products')
                    .insert({
                        id: testProduct.id,
                        name: testProduct.name,
                        description: testProduct.description,
                        type: testProduct.type,
                        quantity: testProduct.quantity,
                        min_quantity: testProduct.minQuantity,
                        unit: testProduct.unit,
                        created_by: (await auth.getCurrentUser()).id,
                        updated_by: (await auth.getCurrentUser()).id
                    });

                if (insertError) throw insertError;

                // Atualizar produto
                const { error: updateError } = await supabaseClient
                    .from('products')
                    .update({ quantity: 15 })
                    .eq('id', testProduct.id);

                if (updateError) throw updateError;

                // Deletar produto
                const { error: deleteError } = await supabaseClient
                    .from('products')
                    .delete()
                    .eq('id', testProduct.id);

                if (deleteError) throw deleteError;

                showResults('crudResults', '‚úÖ CRUD de produtos funcionando perfeitamente!', 'success');
            } catch (error) {
                showResults('crudResults', '‚ùå Erro no CRUD de produtos: ' + error.message, 'error');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Testar CRUD de movimenta√ß√µes
        async function testMovementCRUD() {
            const resultsDiv = document.getElementById('crudResults');
            
            if (!isAuthenticated) {
                showResults('crudResults', '‚ùå Fa√ßa login primeiro', 'error');
                return;
            }

            try {
                // Primeiro, criar um produto para testar movimenta√ß√£o
                const testProduct = {
                    id: 'test-movement-product-' + Date.now(),
                    name: 'Produto para Movimenta√ß√£o',
                    type: 'teste',
                    quantity: 10,
                    min_quantity: 5,
                    unit: 'unid'
                };

                await supabaseClient.from('products').insert({
                    id: testProduct.id,
                    name: testProduct.name,
                    type: testProduct.type,
                    quantity: testProduct.quantity,
                    min_quantity: testProduct.min_quantity,
                    unit: testProduct.unit,
                    created_by: (await auth.getCurrentUser()).id
                });

                // Criar movimenta√ß√£o
                const movementId = 'test-movement-' + Date.now();
                const { error: insertError } = await supabaseClient
                    .from('movements')
                    .insert({
                        id: movementId,
                        product_id: testProduct.id,
                        type: 'entrada',
                        quantity: 5,
                        timestamp: new Date().toISOString(),
                        created_by: (await auth.getCurrentUser()).id
                    });

                if (insertError) throw insertError;

                // Deletar movimenta√ß√£o
                const { error: deleteError } = await supabaseClient
                    .from('movements')
                    .delete()
                    .eq('id', movementId);

                if (deleteError) throw deleteError;

                // Deletar produto de teste
                await supabaseClient.from('products').delete().eq('id', testProduct.id);

                showResults('crudResults', '‚úÖ CRUD de movimenta√ß√µes funcionando perfeitamente!', 'success');
            } catch (error) {
                showResults('crudResults', '‚ùå Erro no CRUD de movimenta√ß√µes: ' + error.message, 'error');
            }
        }

        // Testar log de auditoria
        async function testAuditLog() {
            const resultsDiv = document.getElementById('auditResults');
            const loadingDiv = document.getElementById('auditLoading');

            if (!isAuthenticated) {
                showResults('auditResults', '‚ùå Fa√ßa login primeiro', 'error');
                return;
            }

            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            try {
                const { data, error } = await supabaseClient
                    .from('audit_log')
                    .select(`
                        *,
                        users:user_id(email, full_name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                if (data && data.length > 0) {
                    const auditInfo = data.map(log => {
                        const userName = log.users ? (log.users.full_name || log.users.email) : 'Usu√°rio removido';
                        return `‚Ä¢ ${log.action} em ${log.table_name} por ${userName} (${new Date(log.created_at).toLocaleString('pt-BR')})`;
                    }).join('<br>');

                    showResults('auditResults', `‚úÖ Log de auditoria funcionando!<br><br><strong>√öltimas 10 a√ß√µes:</strong><br>${auditInfo}`, 'success');
                } else {
                    showResults('auditResults', '‚ÑπÔ∏è Log de auditoria vazio (nenhuma a√ß√£o registrada ainda)', 'info');
                }
            } catch (error) {
                showResults('auditResults', '‚ùå Erro ao verificar log de auditoria: ' + error.message, 'error');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Fun√ß√£o auxiliar para mostrar resultados
        function showResults(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = message;
            container.className = `test-results status-${type}`;
            container.style.display = 'block';
        }
    </script>
</body>
</html>
